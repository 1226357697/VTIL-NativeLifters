PUBLIC emulate_and_return

.code

emulate_and_return PROC
	mov     rax, rsp
	mov     rsp, rcx
	add     rsp, 20h
	mov     [rsp+188h], rax

	lea rax, qword ptr [rsp+178h]

	push    qword ptr [rax]
	pushfq
	pop     qword ptr [rax]
	popfq

	xchg    rax, [rsp+100h]
	xchg    rbx, [rsp+108h]
	xchg    rcx, [rsp+110h]
	xchg    rdx, [rsp+118h]
	xchg    rsi, [rsp+120h]
	xchg    rdi, [rsp+128h]
	xchg    rbp, [rsp+130h]
	xchg    r8, [rsp+138h]
	xchg    r9, [rsp+140h]
	xchg    r10, [rsp+148h]
	xchg    r11, [rsp+150h]
	xchg    r12, [rsp+158h]
	xchg    r13, [rsp+160h]
	xchg    r14, [rsp+168h]
	xchg    r15, [rsp+170h]

	call    qword ptr [rsp+180h]
	
	xchg    rax, [rsp+100h]
	xchg    rbx, [rsp+108h]
	xchg    rcx, [rsp+110h]
	xchg    rdx, [rsp+118h]
	xchg    rsi, [rsp+120h]
	xchg    rdi, [rsp+128h]
	xchg    rbp, [rsp+130h]
	xchg    r8, [rsp+138h]
	xchg    r9, [rsp+140h]
	xchg    r10, [rsp+148h]
	xchg    r11, [rsp+150h]
	xchg    r12, [rsp+158h]
	xchg    r13, [rsp+160h]
	xchg    r14, [rsp+168h]
	xchg    r15, [rsp+170h]

	lea rax, qword ptr [rsp+178h]

	push    qword ptr [rax]
	pushfq
	pop     qword ptr [rax]
	popfq


	mov     rsp, [rsp+188h]
	ret
emulate_and_return ENDP

END